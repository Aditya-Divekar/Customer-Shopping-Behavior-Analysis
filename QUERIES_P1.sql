use customer_trends;

SELECT * FROM CUSTOMERS;
select COUNT(*) FROM CUSTOMERS;


-- 1.) TOTAL REVENUE GENERATED BY MALE AND FEMALE --

SELECT GENDER ,SUM(PURCHASE_AMOUNT) as 'Revenue'
FROM CUSTOMERS
GROUP BY GENDER;


-- 2.) WHICH CUSTOMER IS USED A DISCOUNT BUT STILL SPENT MORE THAN AVG PURCHASE AMOUNT --

SELECT CUSTOMER_ID,PURCHASE_AMOUNT
FROM CUSTOMERS
WHERE DISCOUNT_APPLIED = 'YES' AND PURCHASE_AMOUNT >= (SELECT AVG (PURCHASE_AMOUNT) FROM CUSTOMERS);


-- 3.) WHICH ARE THE TOP 5 PRODUCTS  HAVING HIGHEST AVG REVIEW RATING --

SELECT  
    ITEM_PURCHASED,
    ROUND(AVG(CAST(REVIEW_RATING AS DECIMAL(10,2))), 2) AS "AVERAGE_RATINGS"
FROM CUSTOMERS
GROUP BY ITEM_PURCHASED, CATEGORY
ORDER BY AVERAGE_RATINGS DESC
LIMIT 5;


-- 4.) COMPARE AVG  PURCHASE AMOUNT BETWEEN STANDARD AND EXPRESS SHIPING

SELECT SHIPPING_TYPE,
round (AVG(PURCHASE_AMOUNT),2) AS "AVG PURCHASE AMOUNT"
FROM CUSTOMERS
WHERE SHIPPING_TYPE IN ("STANDARD","EXPRESS")
group by SHIPPING_TYPE;

-- 5.)DO SUBCRIBED CUSTOMER SPENDS MORE? COMPARE AVG SPEND AND TOTAL REVENUE
	--  BETWEEN SUBSCRIBER AND NON SUBSCRIBER
    
    SELECT  SUBSCRIPTION_STATUS,
    (COUNT(CUSTOMER_ID)) AS "TOTAL CUSTOMERS",
    ROUND(AVG(PURCHASE_AMOUNT),2) AS "AVG_SPEND",
    ROUND(SUM(PURCHASE_AMOUNT),2) AS "TOTAL_REVENUE"
    FROM CUSTOMERS
    GROUP BY SUBSCRIPTION_STATUS
    ORDER BY "AVG_SPEND","TOTAL REVENUE";
    
    
-- 6.) WHICH 5 PRODUCTS HAVE THE HIGHEST PERCENTAGE OF PURCHASE WITH  DISCOUNT APPLIED ?
     

SELECT ITEM_PURCHASED,
ROUND (100 * SUM(	
    CASE 
		WHEN DISCOUNT_APPLIED = "YES" THEN 1 
        ELSE 0  
        END) / COUNT(*) ,2) AS "DISCOUNT_RATE"
FROM CUSTOMERS
GROUP BY ITEM_PURCHASED
ORDER BY DISCOUNT_RATE DESC
LIMIT 5;
     
-- Find specific high-value transactions where customers used a discount.-- 
SELECT ITEM_PURCHASED
FROM CUSTOMERS
WHERE PURCHASE_AMOUNT >=  ( SELECT AVG(PURCHASE_AMOUNT) FROM CUSTOMERS) AND DISCOUNT_APPLIED = "YES"
ORDER BY PURCHASE_AMOUNT DESC
LIMIT 5;

-- 7.) SEGMENT CUSTOMER INTO NEW ,LOYAL ,RETURNING BASED ONT THEIR TOTAL NO. OF PREVIOUS PURCHASES
-- 		AND SHOW COUNT OF EACH SEGMENT

WITH CUST_TYPE AS(
	SELECT PREVIOUS_PURCHASES,CUSTOMER_ID,
    CASE
		WHEN PREVIOUS_PURCHASES = 1 THEN 'NEW'
        WHEN PREVIOUS_PURCHASES  BETWEEN 2 AND 10 THEN 'RETURNING'
	ELSE 'LOYAL'
	END  AS SEGMENT FROM CUSTOMERS)
    
    SELECT SEGMENT,COUNT(*) AS 'NO_OF_CUSTOMERS'
    FROM CUST_TYPE
    GROUP BY SEGMENT;
    
    -- 8.) WHAT ARE THE TOP 3 MOST PRODUCTS PURCHASED WITHIN THE EACH CATEGORY
    
    WITH ITEM_COUNTS AS (
    SELECT ITEM_PURCHASED, CATEGORY,
    COUNT(CUSTOMER_ID)AS 'TOTAL_ORDERS',
    ROW_NUMBER() OVER ( partition by CATEGORY ORDER BY COUNT(CUSTOMER_ID)DESC) AS 'ITEM_RANK'
    FROM CUSTOMERS
    GROUP BY CATEGORY , ITEM_PURCHASED)
    
    SELECT CATEGORY,ITEM_PURCHASED,TOTAL_ORDERS,ITEM_RANK
    FROM ITEM_COUNTS
    WHERE ITEM_RANK <= 3;
    
    -- 9) ARE THE CUSTOMER WHO ARE REPEAT BUYERS ( MORE THAN 5 PREVIOUS PURCHASES) ALSO LIKELY TO SUBSCRIBE ?
    
SELECT SUBSCRIPTION_STATUS,
COUNT(CUSTOMER_ID) AS 'REPEAT_BUYERS'
FROM CUSTOMERS
WHERE PREVIOUS_PURCHASES > 5
GROUP BY SUBSCRIPTION_STATUS;

-- 10.) WHAT IS THE REVENUE CONTRIBUTION OF EACH AGE GROUP?

SELECT AGE_GROUP,
SUM(PURCHASE_AMOUNT) AS 'TOTAL_REVENUE'
FROM CUSTOMERS
GROUP BY AGE_GROUP
ORDER BY TOTAL_REVENUE DESC ;